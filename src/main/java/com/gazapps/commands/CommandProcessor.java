package com.gazapps.commands;

import java.util.Set;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import java.nio.file.Files;
import java.nio.file.Paths;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.gazapps.config.EnvironmentSetup;
import com.gazapps.config.RuntimeConfigManager;
import com.gazapps.core.ChatEngine;
import com.gazapps.core.ChatEngineBuilder;
import com.gazapps.mcp.MCPServers;

import io.modelcontextprotocol.client.McpSyncClient;
import io.modelcontextprotocol.spec.McpSchema.ListToolsResult;

public class CommandProcessor {
    private static final Logger logger = LoggerFactory.getLogger(CommandProcessor.class);
    private static final Pattern COMMAND_PATTERN = Pattern.compile("^/(\\w+)(?:\\s+(.+))?$");
    
    private static final Set<String> VALID_LLM_PROVIDERS = Set.of("groq", "gemini", "claude", "openai");
    private static final Set<String> VALID_INFERENCE_STRATEGIES = Set.of("simple", "react", "reflection");
    
    private static final String WORKSPACE_HELP = """
        Available commands:
          /workspace setup    - Configure new workspace
          /workspace check    - Validate current workspace
          /workspace          - Show workspace status""";
    
    private ChatEngine currentChatEngine;
    private final RuntimeConfigManager configManager;
    private MCPServers mcpServers;
    
    public CommandProcessor(ChatEngine chatEngine, RuntimeConfigManager configManager, MCPServers mcpServers) {
        this(chatEngine, configManager);
        this.mcpServers = mcpServers;
    }
    
    public CommandProcessor(ChatEngine chatEngine, RuntimeConfigManager configManager) {
        this.currentChatEngine = chatEngine;
        this.configManager = configManager;
    }
    
    public CommandResult processCommand(String input) {
        try {
            if (!isCommand(input)) {
                return CommandResult.error("Not a valid command format");
            }
            
            Matcher matcher = COMMAND_PATTERN.matcher(input.trim());
            if (!matcher.matches()) {
                return CommandResult.error("Invalid command syntax");
            }
            
            String command = matcher.group(1).toLowerCase();
            String parameter = matcher.group(2);
            
            return switch (command) {
                case "llm" -> handleLlmCommand(parameter);
                case "inference" -> handleInferenceCommand(parameter);
                case "config" -> handleConfigCommand();
                case "help" -> handleHelpCommand();
                case "status" -> handleStatusCommand();
                case "tools" -> handleToolsCommand();
                case "workspace" -> handleWorkspaceCommand(parameter);
                default -> CommandResult.error("Unknown command: " + command + "\nType /help for available commands");
            };
        } catch (Exception e) {
            logger.error("Command processing error", e);
            return CommandResult.error("Error processing command: " + e.getMessage());
        }
    }
    
    private boolean isCommand(String input) {
        return input != null && input.trim().startsWith("/");
    }
    
    private CommandResult handleLlmCommand(String provider) {
        if (isNullOrEmpty(provider)) {
            return CommandResult.error("""
                ‚ùå Provider parameter required
                Usage: /llm <provider>
                Available providers: groq, gemini, claude, openai""");
        }
        
        provider = provider.trim().toLowerCase();
        
        if (!VALID_LLM_PROVIDERS.contains(provider)) {
            return CommandResult.error(String.format("""
                ‚ùå Unknown LLM provider '%s'
                Available providers: groq, gemini, claude, openai
                Usage: /llm <provider>""", provider));
        }
        
        try {
            if (!EnvironmentSetup.isProviderConfigured(provider)) {
                logger.info("Provider {} not configured, offering inline setup", provider);
                if (!EnvironmentSetup.setupProviderInline(provider)) {
                    return CommandResult.error("‚ùå Configuration cancelled. Cannot switch to " + provider + ".");
                }
            }
            
            logger.info("Attempting to change LLM to: {}", provider);
            ChatEngineBuilder.LlmProvider llmProvider = ChatEngineBuilder.LlmProvider.valueOf(provider.toUpperCase());
            ChatEngine newEngine = configManager.recreateChatEngineWithNewLlm(currentChatEngine, llmProvider);
            
            if (!configManager.validateConfiguration(newEngine)) {
                return CommandResult.error("‚ùå Failed to configure " + provider + ". Please check API key and connectivity.");
            }
            
            updateChatEngine(newEngine);
            return createLlmSuccessResponse(provider, llmProvider);
        } catch (Exception e) {
            logger.error("LLM change failed", e);
            return CommandResult.error("‚ùå Failed to change LLM to " + provider + ": " + e.getMessage());
        }
    }
    
    private CommandResult createLlmSuccessResponse(String provider, ChatEngineBuilder.LlmProvider llmProvider) {
        String providerDisplayName = switch (llmProvider) {
            case GROQ -> "Groq (Llama 3.3 70B Versatile)";
            case GEMINI -> "Gemini (2.0 Flash)";
            case CLAUDE -> "Claude (3.5 Sonnet)";
            case OPENAI -> "OpenAI (GPT-4)";
        };
        
        return CommandResult.success(String.format("""
            ‚úÖ LLM changed to %s
            üíæ Conversation history preserved
            ‚è±Ô∏è Ready""", providerDisplayName), currentChatEngine);
    }
    
    private CommandResult handleInferenceCommand(String strategy) {
        if (isNullOrEmpty(strategy)) {
            return CommandResult.error("""
                ‚ùå Strategy parameter required
                Usage: /inference <strategy>
                Available strategies: sequential, react, tooluse, reflection""");
        }
        
        strategy = strategy.trim().toLowerCase();
        
        if (!VALID_INFERENCE_STRATEGIES.contains(strategy)) {
            return CommandResult.error(String.format("""
                ‚ùå Unknown inference strategy '%s'
                Available strategies: sequential, react, tooluse, reflection
                Usage: /inference <strategy>""", strategy));
        }
        
        try {
            logger.info("Attempting to change inference to: {}", strategy);
            ChatEngineBuilder.InferenceStrategy inferenceStrategy = 
                ChatEngineBuilder.InferenceStrategy.valueOf(strategy.toUpperCase());
            
            ChatEngine newEngine = configManager.recreateChatEngineWithNewInference(currentChatEngine, inferenceStrategy);
            
            if (!configManager.validateConfiguration(newEngine)) {
                return CommandResult.error("‚ùå Failed to configure " + strategy + " inference strategy.");
            }
            
            updateChatEngine(newEngine);
            return createInferenceSuccessResponse(inferenceStrategy);
        } catch (Exception e) {
            logger.error("Inference change failed", e);
            return CommandResult.error("‚ùå Failed to change inference to " + strategy + ": " + e.getMessage());
        }
    }
    
    private CommandResult createInferenceSuccessResponse(ChatEngineBuilder.InferenceStrategy strategy) {
        String strategyDisplayName = switch (strategy) {
            case SIMPLE -> "Simple";
            case REACT -> "ReAct (Reasoning and Acting)";
            case REFLECTION -> "Reflection (Self-Improvement)";
        };
        
        return CommandResult.success(String.format("""
            ‚úÖ Inference strategy changed to %s
            üß† Strategy active
            üíæ Conversation history preserved
            ‚è±Ô∏è Ready""", strategyDisplayName), currentChatEngine);
    }
    
    private CommandResult handleConfigCommand() {
        try {
            return CommandResult.success("üìä Current Configuration:\n" + 
                configManager.getCurrentConfigSummary(currentChatEngine));
        } catch (Exception e) {
            logger.error("Failed to get config summary", e);
            return CommandResult.error("‚ùå Failed to retrieve configuration");
        }
    }
    
    private CommandResult handleStatusCommand() {
        try {
            String llmProvider = currentChatEngine.getLLMService().getProviderName();
            String inferenceStrategy = currentChatEngine.getInference().getClass().getSimpleName();
            int memorySize = currentChatEngine.getMemory().getRecentMessages().size();
            
            return CommandResult.success(String.format("""
                üìä System Status:
                ü§ñ LLM: %s
                üß† Inference: %s
                üíæ Memory: %d messages
                üîß MCP Tools: Available
                ‚ö° Status: Ready""", llmProvider, inferenceStrategy, memorySize));
        } catch (Exception e) {
            logger.error("Failed to get status", e);
            return CommandResult.error("‚ùå Failed to retrieve system status");
        }
    }
    
    private CommandResult handleToolsCommand() {
        try {
            if (mcpServers.getConnectedServers().isEmpty()) {
                return CommandResult.success("üîß Available MCP Tools:\n\n‚ö†Ô∏è No MCP servers currently connected");
            }
            
            StringBuilder toolsList = new StringBuilder("üîß Available MCP Tools:\n\n");
            mcpServers.getConnectedServers().forEach(server -> {
                McpSyncClient client = mcpServers.getClient(server.name);
                ListToolsResult toolsResult = client.listTools();
                
                toolsList.append("üñ•Ô∏è Server: ").append(server.name).append("\n");
                toolsResult.tools().forEach(tool -> 
                    toolsList.append("  ‚Ä¢ ").append(tool.name()).append("\n"));
                toolsList.append("\n");
            });
            
            if (toolsList.toString().equals("üîß Available MCP Tools:\n\n")) {
                toolsList.append("‚ÑπÔ∏è No tools available on connected servers\n");
            }
            
            toolsList.append("\nUse these tools by asking natural language questions!");
            return CommandResult.success(toolsList.toString());
        } catch (Exception e) {
            logger.error("Failed to list tools", e);
            return CommandResult.error("‚ùå Failed to retrieve tools list: " + e.getMessage());
        }
    }
    
    private CommandResult handleWorkspaceCommand(String parameter) {
        try {
            if (isNullOrEmpty(parameter)) {
                return showWorkspaceStatus();
            }
            
            return switch (parameter.trim().toLowerCase()) {
                case "setup" -> handleWorkspaceSetup();
                case "check" -> handleWorkspaceCheck();
                default -> CommandResult.error(String.format("‚ùå Unknown workspace command '%s'\n%s", 
                    parameter, WORKSPACE_HELP));
            };
        } catch (Exception e) {
            logger.error("Workspace command failed", e);
            return CommandResult.error("‚ùå Failed to process workspace command: " + e.getMessage());
        }
    }
    
    private CommandResult showWorkspaceStatus() {
        StringBuilder status = new StringBuilder("üìÅ MCP Workspace Status:\n\n");
        String currentPath = EnvironmentSetup.getCurrentWorkspacePath();
        
        if (currentPath == null) {
            status.append("‚ùå Not configured\n");
        } else {
            String expandedPath = EnvironmentSetup.getExpandedWorkspacePath();
            status.append("‚úÖ Configured: ").append(currentPath).append("\n")
                 .append("üìÇ Resolved: ").append(expandedPath).append("\n")
                 .append(EnvironmentSetup.isWorkspaceConfigured() ? 
                     "‚úÖ Status: Active and accessible\n" : "‚ùå Status: Path not accessible\n");
        }
        
        status.append("\nüìù Commands:\n")
             .append("  /workspace setup    - Configure new workspace\n")
             .append("  /workspace check    - Validate current workspace\n")
             .append("  /workspace          - Show this status\n");
        
        return CommandResult.success(status.toString());
    }
    
    private CommandResult handleWorkspaceSetup() {
        try {
            System.out.println("\nüîß Starting workspace reconfiguration...");
            return EnvironmentSetup.setupWorkspace() ? 
                CommandResult.success("""
                    ‚úÖ Workspace reconfigured successfully!
                    üîÑ Please restart JavaCLI for MCP servers to use the new workspace.
                    
                    üí° Why restart? MCP servers load workspace at startup and need
                       to be reinitialized to access the new folder.
                    
                    üöÄ Just close and run JavaCLI again - your settings are saved!""") :
                CommandResult.error("‚ùå Workspace setup cancelled or failed.");
        } catch (Exception e) {
            logger.error("Workspace setup failed", e);
            return CommandResult.error("‚ùå Workspace setup failed: " + e.getMessage());
        }
    }
    
    private CommandResult handleWorkspaceCheck() {
        try {
            String currentPath = EnvironmentSetup.getCurrentWorkspacePath();
            if (currentPath == null) {
                return CommandResult.success("""
                    üîç Workspace Validation:
                    
                    ‚ùå No workspace configured
                    Run '/workspace setup' to configure one.""");
            }
            
            StringBuilder result = new StringBuilder(String.format("""
                üîç Workspace Validation:
                
                üìÅ Configured Path: %s
                üìÇ Expanded Path: %s
                
                """, currentPath, EnvironmentSetup.getExpandedWorkspacePath()));
            
            validateWorkspacePath(result);
            return CommandResult.success(result.toString());
        } catch (Exception e) {
            logger.error("Workspace check failed", e);
            return CommandResult.error("‚ùå Workspace check failed: " + e.getMessage());
        }
    }
    
    private void validateWorkspacePath(StringBuilder result) {
        try {
            var path = Paths.get(EnvironmentSetup.getExpandedWorkspacePath());
            
            if (!Files.exists(path)) {
                result.append("‚ùå Directory does not exist\n");
                return;
            }
            
            result.append(Files.isDirectory(path) ? "‚úÖ Is a directory\n" : "‚ùå Path is not a directory\n")
                 .append(Files.isReadable(path) ? "‚úÖ Directory is readable\n" : "‚ùå Directory is not readable\n")
                 .append(Files.isWritable(path) ? "‚úÖ Directory is writable\n" : "‚ùå Directory is not writable\n");
        } catch (Exception e) {
            result.append("‚ùå Error accessing path: ").append(e.getMessage()).append("\n");
        }
    }
    
    private CommandResult handleHelpCommand() {
        return CommandResult.success("""
            ü§ñ JavaCLI Help
            
            üí¨ Chat Commands:
               Just type your message and press Enter
            
            üîß Configuration Commands:
               /llm <provider>        - Change LLM provider
                 Providers: groq, gemini, claude, openai
                 Example: /llm groq
               
               /inference <strategy>  - Change inference strategy  
                 Strategies: sequential, react, tooluse, reflection
                 Example: /inference react
               
               /workspace [command]   - Manage MCP workspace
                 Commands: setup, check
                 Example: /workspace setup
               
               /config               - Show current configuration
               /help                 - Show this help
            
            üìä Status Commands:
               /status               - System status and performance
               /tools                - List available MCP tools
               /workspace            - Show workspace status
            
            üö™ Exit Commands:
               exit, quit, bye, sair, tchau
            
            üí° Tips:
               - Be specific in your requests
               - Use tools for file operations, weather, time, etc.
               - Configuration changes preserve your conversation history
               - MCP filesystem server uses your configured workspace
            
            Example session:
               You: /llm gemini
               ü§ñ: ‚úÖ LLM changed to Gemini (2.0 Flash)
               
               You: /workspace setup
               ü§ñ: [Interactive workspace configuration]
               
               You: What's the weather like?
               ü§ñ: [Uses weather tools to get forecast]""");
    }
    
    private boolean isNullOrEmpty(String str) {
        return str == null || str.trim().isEmpty();
    }
    
    public void updateChatEngine(ChatEngine newChatEngine) {
        this.currentChatEngine = newChatEngine;
    }
}